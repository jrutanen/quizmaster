<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="quiz.css">
    <script src="jquery-1.11.3.min.js"></script>
    <script src="d3.min.js"></script>
    <script type="text/javascript">
        gameStarted = false;
        //question number needs to be increased by 3 for each round
        questionNbr = 0;
        user = "";
        diff = 0;
        timeLeft = 20;
        var questions;
        var gametime;

        function drawPage(){
            if (questionNbr == 0 && !gameStarted) {
                signScreen();
            } else if (questionNbr > 0 && !gameStarted) {
                waitScreen();
            } else {
                qNumber = questionNbr;
                questionScreen(qNumber);
            }
            $('body').show();
        }

        function signScreen(){
            $("div.registerForm").show();
            $("div.answerForm").hide();
            $("div.waitScreen").hide();
        }

        function waitScreen(){
            $("div.registerForm").hide();
            $("div.answerForm").hide();
            $("div.waitScreen").show();
            getGameStatus();
        }

        function getGameStatus() {
//            alert( "Getting game status");
            $.get( "running.php", function( data ) {
//                alert( "Running page: " + data );
                if ( data == 1 ) {
//                    alert( "Game Started, status:" + data );
                    gameStarted = true;
                    getQuestions();
                } else {
//                    alert( "Game Not Started, status:" + data );
                    gameStarted = false;
                    getGameStatus();
                }
            });
        }
        function getQuestions() {
//            alert( "Getting Questions...");
            $.get( "getquestions.php?quiz=1", function( data ) {
//                alert( "Running page: " + data );
                questions = JSON.parse( data );
                gametime = setInterval(updateClock, 1000);
                drawPage();
            });
        }

        function questionScreen(questionNbr){
            $("div.registerForm").hide();
            $("div.answerForm").show();
            $('#qOne').attr("disabled", false);
            $('#qTwo').attr("disabled", false);
            $('#qThree').attr("disabled", false);
            $("#qOne").attr('value',questions[questionNbr-1].answer.replace(/"/g, ''));
            $("#qTwo").attr('value',questions[questionNbr].answer.replace(/"/g, ''));
            $("#qThree").attr('value',questions[questionNbr+1].answer.replace(/"/g, ''));
            $("div.waitScreen").hide();
        }

        function onRegister() {
            var e = document.getElementById("teamDropDown");
            user = e.options[e.selectedIndex].value;
            questionNbr++;
            drawPage();
        }

        function updateClock() {
            timeLeft = timeLeft -1;
            $("div.playtime").html("<h2>" + timeLeft + "</h2>");
            if (timeLeft == 0) {
                timeLeft = 20;
                questionNbr = questionNbr + 3;
                drawPage();
            }
        }
        function endGame() {
            gameStarted = false;
        }

        function registerAnswer(q, a) {
            var number = 0;
            if(a != -1) { $('#qOne').attr("disabled", true); }
            if(a != 0) { $('#qTwo').attr("disabled", true); }
            if(a != 1) { $('#qThree').attr("disabled", true); }
            if(questions[q+a].correct == 1) {
                if(questionNbr == 1) {
                    number = questionNbr;
                    diff = diff + 2;
                } else {
                    number = questionNbr - diff;
                    diff = diff + 2;
                }
                //answer was correct update database
                $.get( "sendanswer.php?user=" + user + "&quiz=1&question=" + number, function( data ) {
//                    alert( "Answer Sent");
                });
            } else {
                //answer was incorrect, do nothing
            }
//            alert( "You answered: " + q + ": " + a);
        }

        window.onload = drawPage;
    </script>
    <title>Leaderboard</title>
</head>
<style>

    .axis text {
        font: 10px sans-serif;
    }

    .axis line,
    .axis path {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .axis--x path {
        display: none;
    }

</style>
<body>
<script>

    var causes = ["wounds", "other", "disease"];

    var parseDate = d3.time.format("%m/%Y").parse;

    var margin = {top: 20, right: 50, bottom: 30, left: 20},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

    var x = d3.scale.ordinal()
            .rangeRoundBands([0, width]);

    var y = d3.scale.linear()
            .rangeRound([height, 0]);

    var z = d3.scale.category10();

    var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .tickFormat(d3.time.format("%b"));

    var yAxis = d3.svg.axis()
            .scale(y)
            .orient("right");

    var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.tsv("crimea.tsv", type, function(error, crimea) {
        if (error) throw error;

        var layers = d3.layout.stack()(causes.map(function(c) {
            return crimea.map(function(d) {
                return {x: d.date, y: d[c]};
            });
        }));

        x.domain(layers[0].map(function(d) { return d.x; }));
        y.domain([0, d3.max(layers[layers.length - 1], function(d) { return d.y0 + d.y; })]).nice();

        var layer = svg.selectAll(".layer")
                .data(layers)
                .enter().append("g")
                .attr("class", "layer")
                .style("fill", function(d, i) { return z(i); });

        layer.selectAll("rect")
                .data(function(d) { return d; })
                .enter().append("rect")
                .attr("x", function(d) { return x(d.x); })
                .attr("y", function(d) { return y(d.y + d.y0); })
                .attr("height", function(d) { return y(d.y0) - y(d.y + d.y0); })
                .attr("width", x.rangeBand() - 1);

        svg.append("g")
                .attr("class", "axis axis--x")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

        svg.append("g")
                .attr("class", "axis axis--y")
                .attr("transform", "translate(" + width + ",0)")
                .call(yAxis);
    });

    function type(d) {
        d.date = parseDate(d.date);
        causes.forEach(function(c) { d[c] = +d[c]; });
        return d;
    }

</script>
</body>
</html>